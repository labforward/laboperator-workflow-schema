schema_version: 0.0.1
info:
  version: 1.0.1
  uuid: 848b05e2-7e86-4f9d-9067-825c3597ec28
  title: My Premium Workflow
  description: |
    Add a fancy description here. It even supports __Markdown__!
  author:
    name: Max Mustermann
    email: max.mustermann@company.com
  slug: my-premium-workflow
config:
  contextInfoSettings:
    toggleButton:
      label: Overflowing Context Toggle Button
    contentPanel:
      color: "#002b56"
      height: 140
  reportHeader: Experiment {{run.data.attributes.title}}
contextInfo:
  pages:
    - title: Global Info
      content: >
        *Once, if my memory serves me well, my life was a banquet where every
        heart revealed itself, where every wine flowed.* — Arthur Rimbaud
behaviors:
  - when: run_start
    do:
      alert:
        title: Starting!
        text: Here we go!
fields:
  someString:
    type: string
    maxLength: 100
    defaultValue: Test
  balance:
    type: relationship
    resourceType: devices
    prepare: true
  instrumentInstructions:
    type: file
    mediaType: application/my-instruments-config-file-type
    prepare: true
    readOnly: true
    output: false
  actualWeight:
    type: quantity
    unit: mg
  actualVolume:
    type: quantity
    unit: ml
  density:
    type: script
    script: actualWeight / actualVolume
    readOnly: true
    result:
      type: quantity
      unit: mg
  selectorResult:
    type: string
    hidden: true
    maxLength: 100
  iterator:
    type: integer
    hidden: true
  collection:
    type: array
    items:
      type: string
    defaultValue:
      - one
      - two
      - three
steps:
  weighing:
    info:
      title: Weighing
    contextInfo:
      pages:
        - title: Really Long Weighing Info Page Title
          content: >
            *One chord is fine. Two chords is pushing it. Three chords and you're
            into jazz.* — Lou Reed


            ![music](https://source.unsplash.com/600x400/?music)
    fields:
      sample:
        type: relationship
        resourceType: samples
      target:
        type: quantity
        unit: mg
      actual:
        type: quantity
        unit: mg
    substeps:
      - primary: Place the {{sample}} on the balance.
        description: |
          Your fancy markdown body with formatting, images and what not else!
        confirm: true
        timer:
          type: timer
          defaultDuration: 5s
      - primary: Selector
        confirm: true
        selector:
          layout: list
          result: selectorResult
          title: Treats
          description: >
            You nailed that first substep. You deserve to treat yourself.
            Choose ~~one~~ **multiple** options!
          multiSelection: true
          skipBehaviors: false
          options:
            - primary: Red Hawk Cheese
              secondary: >
                Red Hawk is a type of American triple-crème aged cow's-milk cheese
                with a brine-washed rind produced by the Cowgirl Creamery in
                Point Reyes Station, California.
              thumbnail: https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Cowgirl_Creamery_Point_Reyes_-_Red_Hawk_cheese.jpg/320px-Cowgirl_Creamery_Point_Reyes_-_Red_Hawk_cheese.jpg
              value: cheese
            - primary: Red Wine
              secondary: >
                Wine comes in at the mouth. And love comes in at the eye; That’s all
                we shall know for truth, before we grow old and die.
              thumbnail: https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Tempranillowine.jpg/320px-Tempranillowine.jpg
              value: wine
            - primary: Espresso
              secondary: >
                The size can be a single, double, or triple, using a proportional
                amount of ground coffee, roughly 7, 14, and 21 grams;
                correspondingly sized filter baskets are used.
              thumbnail: https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Doppio.jpg/320px-Doppio.jpg
              value: espresso
    reportSummary: "{{template.steps.weighing.info.title}}: This is the information
      that will be generated by this step, when it's completed, in the report.
      We have a field reference here: {{someString}}. Completed by
      {{operator.data.attributes.full_name}}"
  externalStep:
    uuid: b3fc8c2b-aa03-4ab7-9172-377ef38fd860
    version: 1.0.0
  stirring:
    info:
      title: Stirring
    contextInfo:
      pages:
        - title: Dosing Info
          content: >
            *I like to occasionally write an infinite loop to remind my computer
            who's boss.* — Ben Awad
    reportSummary: This is the report for the stirring step.
    substeps:
      - primary: The wheel on the bus goes round and round
  measurement:
    info:
      title: A Great Step
      description: |
        Add a fancy description here. It even supports __Markdown__!
    behaviors:
      - when: ON_SUBSTEP_START
        do:
          notify:
            text: Starting substep of externalStep
            variant: info
            autoHideDuration: 50
    fields:
      sample:
        type: string
        maxLength: 100
      powderDispenser:
        type: relationship
        resourceType: devices
        prepare: true
    substeps:
      - primary: Load a {{sample}} into the {{powderDispenser}}.
        secondary: Please, confirm when you are done.
        confirm: true
      - primary: >
          The sample will be gravimetrically placed in a {{target}} reaction
          tube.
        devices:
          - powderDispenser
        behaviors:
          - title: Start gravimetrical measurement
            when: ON_SUBSTEP_START
            do:
              - SEND_COMMAND:
                  device: powderDose
                  command: GET_GRAVIMETRICAL_MEASUREMENT
                  scope: substep
          - title: Record result
            when:
              ON_COMMAND_RESPONSE:
                device: powderDose
                command: GET_GRAVIMETRICAL_MEASUREMENT
            and: data.value >= 9 && data.value <= 11
            do:
              - SET_FIELD:
                  field: actual
                  value: data.value
              - COMPLETE_SUBSTEP
            else:
              - ALERT:
                  title: Tolerance Missed
                  text: |
                    Result is not within tolerance of 1 {{target.unit}} of the
                    target of {{target}}. Repeat the step.
              - REPEAT_STEP
      - primary: |
          Results after gravimetrical placement are recorded: {{actual}}
        behaviors:
          - when: ON_SUBSTEP_START
            do:
              - COMPLETE_SUBSTEP
              - COMPLETE_STEP
      - primary: Send results to ELN
        behaviors:
          - when: ON_SUBSTEP_COMPLETE
            do:
              - webhook:
                  url: http://localhost:5000/__cypress__/webhook?status=200&body=6
                  method: post
                  blocking: false
                  headers:
                    content-type: application/json
                  body: |
                    {
                      "registered_value": "{{someString}}",
                      "description": "some information goes here"
                    }
                  onSuccess:
                    do:
                      - SET_FIELD:
                          field: actual
                          value: data.value
                      - webhook:
                          url: http://localhost:5000/__cypress__/webhook?status=204
                  onError:
                    do:
                      - REPEAT_SUBSTEP
                  onCode:
                    "404":
                      do:
                        - ALERT:
                            title: Not Found
                            text: Ensure that you're using a valid url / endpoint
                    "418":
                      do:
                        - ALERT:
                            title: I'm a teapot
                            text: For real! I'm a teapot
  alert:
    info:
      title: Alert completed
    substeps:
      - primary: Ahoy, Matey!
    behaviors:
      - title: Alert that we are done.
        when: ON_STEP_START
        do:
          - ALERT:
              title: Finished!
              text: We are done here.
  buttonStep:
    info:
      title: A step with a handled button.
    substeps:
      - primary: This is a step with a button.
        buttons:
          - label: Click me
            key: clickable-button
        behaviors:
          - when:
              MANUAL:
                key: clickable-button
            do:
              - COMPLETE_SUBSTEP
flow:
  - weighing:
      fields:
        target:
          number: 100
          unit: mg
      fieldMapping:
        actualWeight: actual
        sample: sample
  - buttonStep
  - if: "true"
    then: alert
    else:
      - alert
      - buttonStep
  - loop:
      - weighing
      - weighing
    until: field1 > 20
  - forEach: iterator
    step: 1
    to: 10
    do: weighing
  - while: "true"
    do:
      - weighing
      - weighing
  - forEach: iterator
    in: collection
    do: weighing
  - externalStep:
      fields:
        sample: MySample
      fieldMapping:
        balance: powderDispenser
